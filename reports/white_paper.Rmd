---
title: "Demographic & Housing Market Analysis"
subtitle: "Jefferson County, AL Portfolio Assessment"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    theme: null
    toc: false
    self_contained: true
---

<style>
/* Base Typography */
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
  color: #1a1a1a;
  background-color: #ffffff;
  line-height: 1.6;
  font-size: 16px;
}

.main-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 60px 80px;
}

/* Headers */
h1 {
  font-size: 2.8rem;
  font-weight: 700;
  color: #000;
  margin-bottom: 0.5rem;
  letter-spacing: -0.03em;
  border-bottom: 3px solid #000;
  padding-bottom: 20px;
}

h2 {
  font-size: 1.8rem;
  font-weight: 700;
  color: #000;
  margin-top: 80px;
  margin-bottom: 30px;
  letter-spacing: -0.02em;
}

h3 {
  font-size: 1.3rem;
  font-weight: 600;
  color: #2c3e50;
  margin-top: 40px;
  margin-bottom: 20px;
}

h4 {
  font-size: 1.1rem;
  font-weight: 600;
  color: #34495e;
  margin-top: 30px;
  margin-bottom: 15px;
}

/* Subtitle */
.subtitle {
  font-size: 1.4rem;
  color: #666;
  margin-bottom: 0.5rem;
  font-weight: 400;
}

.date {
  font-size: 0.95rem;
  color: #999;
  margin-bottom: 60px;
}

/* Section Dividers */
hr {
  border: none;
  border-top: 1px solid #e0e0e0;
  margin: 60px 0;
}

/* Key Metrics Grid */
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 30px;
  margin: 40px 0;
}

.metric {
  text-align: center;
  padding: 25px 15px;
  border-left: 3px solid #3498db;
  background: #f8f9fa;
}

.metric-value {
  font-size: 2.5rem;
  font-weight: 700;
  color: #000;
  line-height: 1;
  margin-bottom: 8px;
}

.metric-label {
  font-size: 0.85rem;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-weight: 500;
}

.metric-sublabel {
  font-size: 0.8rem;
  color: #999;
  margin-top: 5px;
}

/* Insight Callouts */
.insight {
  background-color: #f8f9fa;
  border-left: 4px solid #3498db;
  padding: 20px 25px;
  margin: 30px 0;
  font-size: 0.95rem;
  line-height: 1.7;
}

.insight strong {
  color: #2c3e50;
}

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 25px 0;
  font-size: 0.9rem;
}

table thead {
  background-color: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
}

table th {
  padding: 12px 15px;
  text-align: left;
  font-weight: 600;
  color: #2c3e50;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.05em;
}

table td {
  padding: 12px 15px;
  border-bottom: 1px solid #f0f0f0;
}

table tbody tr:hover {
  background-color: #f8f9fa;
}

/* Figure Styling */
.figure {
  margin: 40px 0;
}

img {
  max-width: 100%;
  height: auto;
}

/* Two-column layouts */
.col-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 40px;
  margin: 40px 0;
}

.col-container-thirds {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 30px;
  margin: 40px 0;
}

/* Technical Notes */
.technical-note {
  font-size: 0.85rem;
  color: #666;
  font-style: italic;
  margin-top: 10px;
  padding-left: 15px;
  border-left: 2px solid #e0e0e0;
}

/* Methodology Section */
.methodology {
  background-color: #fafafa;
  padding: 30px;
  margin-top: 60px;
  border-top: 1px solid #e0e0e0;
}

.methodology h3 {
  margin-top: 20px;
}

/* Print Optimization */
@media print {
  .main-container {
    max-width: 100%;
    padding: 20px;
  }

  h2 {
    page-break-before: always;
  }
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  fig.width = 12,
  fig.height = 5,
  dpi = 300
)

library(tidyverse)
library(sf)
library(leaflet)
library(scales)
library(tigris)
library(knitr)
library(gridExtra)

# Load Data
final_data <- read_rds("../data/processed/final_analytical_data.rds")
properties <- final_data$property_reference
property_crosswalk <- final_data$property_crosswalk
tract_counts <- final_data$tract_counts
zcta_counts <- final_data$zcta_counts
tract_history <- final_data$tract_history
zcta_history <- final_data$zcta_history
zcta_history_full <- final_data$zcta_history_full
tract_classifications <- final_data$tract_classifications
zcta_classifications <- final_data$zcta_classifications
zcta_classifications_full <- final_data$zcta_classifications_full
county_history_5yr <- final_data$county_history_5yr
county_history_1yr <- final_data$county_history_1yr
variable_dictionary <- final_data$variable_dictionary

# Setup
options(tigris_use_cache = TRUE)

# Use county 1-year data if available for most recent trends, otherwise 5-year
county_panel <- if(nrow(county_history_1yr) > 0) county_history_1yr else county_history_5yr

# Analysis periods
years_range <- range(tract_history$year, na.rm = TRUE)
analysis_period <- paste(years_range, collapse = "–")

# Portfolio summary
prop_with_classification <- properties %>%
  left_join(tract_classifications, by = c("tract_geoid" = "GEOID"))

total_properties <- nrow(properties)
properties_with_tract <- sum(!is.na(properties$tract_geoid))
growth_properties <- sum(prop_with_classification$classification == "Growth", na.rm = TRUE)
stable_properties <- sum(prop_with_classification$classification == "Stable", na.rm = TRUE)
weakening_properties <- sum(prop_with_classification$classification == "Weakening", na.rm = TRUE)

# County-level summary stats
latest_county <- county_panel %>% filter(year == max(year))
earliest_county <- county_panel %>% filter(year == min(year))

pop_change_county <- (latest_county$total_popE - earliest_county$total_popE) / earliest_county$total_popE
income_change_county <- (latest_county$med_income_real - earliest_county$med_income_real) / earliest_county$med_income_real
vacancy_change_county <- latest_county$vacancy_rate - earliest_county$vacancy_rate

# Tract-level aggregates for portfolio tracts only
portfolio_tracts <- prop_with_classification$tract_geoid %>% na.omit() %>% unique()

tract_latest <- tract_history %>%
  filter(GEOID %in% portfolio_tracts, year == max(year))

tract_earliest <- tract_history %>%
  filter(GEOID %in% portfolio_tracts, year == min(year))

# Average metrics across portfolio tracts (weighted by tract population)
avg_tract_metrics_latest <- tract_latest %>%
  summarise(
    avg_income = weighted.mean(med_income_real, total_popE, na.rm = TRUE),
    avg_vacancy = weighted.mean(vacancy_rate, total_unitsE, na.rm = TRUE),
    avg_renter_pct = weighted.mean(pct_renter, total_unitsE, na.rm = TRUE),
    avg_bachelors_pct = weighted.mean(pct_bachelors, edu_totalE, na.rm = TRUE)
  )
```

## Executive Summary

This report analyzes demographic and housing market trends in Jefferson County, Alabama, with specific focus on the `r total_properties` properties in the portfolio. Data spans `r analysis_period` using U.S. Census American Community Survey (ACS) 5-year estimates, with all monetary values inflation-adjusted to 2023 dollars.

### Portfolio Geographic Distribution

<div class="metrics-grid">
<div class="metric">
<div class="metric-value">`r total_properties`</div>
<div class="metric-label">Total Properties</div>
</div>

<div class="metric">
<div class="metric-value">`r length(portfolio_tracts)`</div>
<div class="metric-label">Census Tracts</div>
</div>

<div class="metric">
<div class="metric-value">`r growth_properties`</div>
<div class="metric-label">Growth Tracts</div>
<div class="metric-sublabel">`r percent(growth_properties/properties_with_tract, 0.1)` of portfolio</div>
</div>

<div class="metric">
<div class="metric-value">`r stable_properties`</div>
<div class="metric-label">Stable Tracts</div>
<div class="metric-sublabel">`r percent(stable_properties/properties_with_tract, 0.1)` of portfolio</div>
</div>

<div class="metric">
<div class="metric-value">`r weakening_properties`</div>
<div class="metric-label">Weakening Tracts</div>
<div class="metric-sublabel">`r percent(weakening_properties/properties_with_tract, 0.1)` of portfolio</div>
</div>
</div>

<div class="technical-note">
**Classification Methodology:** Tracts are classified based on statistically significant changes (using ACS margins of error) in population, real median household income, and vacancy rates over the analysis period. See Technical Appendix for details.
</div>

---

## Jefferson County Market Overview

### Population Trends

```{r county_population, fig.height=4.5}
county_panel %>%
  ggplot(aes(x = year, y = total_popE)) +
  geom_line(size = 1.2, color = "#2c3e50") +
  geom_point(size = 2.5, color = "#2c3e50") +
  scale_y_continuous(labels = comma, expand = c(0.05, 0)) +
  labs(
    title = "Jefferson County Total Population",
    subtitle = paste0("Change: ", percent(pop_change_county, 0.1), " over period"),
    x = NULL,
    y = "Population"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(color = "#666", size = 12),
    panel.grid.minor = element_blank()
  )
```

### Economic Fundamentals

<div class="col-container">
<div>

```{r county_income, fig.height=4.5}
county_panel %>%
  ggplot(aes(x = year, y = med_income_real)) +
  geom_line(size = 1.2, color = "#27ae60") +
  geom_point(size = 2.5, color = "#27ae60") +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "#27ae60", alpha = 0.3) +
  scale_y_continuous(labels = dollar, expand = c(0.05, 0)) +
  labs(
    title = "Median Household Income",
    subtitle = paste0("Real (2023$) change: ", percent(income_change_county, 0.1)),
    x = NULL,
    y = "Income (2023$)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(color = "#666", size = 11),
    panel.grid.minor = element_blank()
  )
```

</div>
<div>

```{r county_employment, fig.height=4.5}
county_panel %>%
  select(year, unemployment_rate, poverty_rate) %>%
  pivot_longer(-year, names_to = "metric", values_to = "rate") %>%
  mutate(metric = case_when(
    metric == "unemployment_rate" ~ "Unemployment Rate",
    metric == "poverty_rate" ~ "Poverty Rate"
  )) %>%
  ggplot(aes(x = year, y = rate, color = metric)) +
  geom_line(size = 1.2) +
  geom_point(size = 2.5) +
  scale_color_manual(values = c("Unemployment Rate" = "#e74c3c", "Poverty Rate" = "#9b59b6")) +
  scale_y_continuous(labels = percent, expand = c(0.05, 0)) +
  labs(
    title = "Economic Stress Indicators",
    subtitle = "County-level unemployment and poverty trends",
    x = NULL,
    y = "Rate",
    color = NULL
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(color = "#666", size = 11),
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  )
```

</div>
</div>

### Housing Market Conditions

<div class="col-container-thirds">
<div>

```{r county_vacancy, fig.height=4}
county_panel %>%
  ggplot(aes(x = year, y = vacancy_rate)) +
  geom_line(size = 1.2, color = "#e67e22") +
  geom_point(size = 2.5, color = "#e67e22") +
  scale_y_continuous(labels = percent, expand = c(0.1, 0)) +
  labs(
    title = "Vacancy Rate",
    subtitle = paste0("Change: ", sprintf("%+.1f", vacancy_change_county * 100), " pp"),
    x = NULL,
    y = "Vacancy Rate"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    plot.subtitle = element_text(color = "#666", size = 10),
    panel.grid.minor = element_blank()
  )
```

</div>
<div>

```{r county_rent, fig.height=4}
county_panel %>%
  ggplot(aes(x = year, y = med_rent_real)) +
  geom_line(size = 1.2, color = "#3498db") +
  geom_point(size = 2.5, color = "#3498db") +
  scale_y_continuous(labels = dollar, expand = c(0.05, 0)) +
  labs(
    title = "Median Rent",
    subtitle = "Real (2023$)",
    x = NULL,
    y = "Monthly Rent"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    plot.subtitle = element_text(color = "#666", size = 10),
    panel.grid.minor = element_blank()
  )
```

</div>
<div>

```{r county_tenure, fig.height=4}
county_panel %>%
  ggplot(aes(x = year, y = pct_renter)) +
  geom_line(size = 1.2, color = "#16a085") +
  geom_point(size = 2.5, color = "#16a085") +
  scale_y_continuous(labels = percent, expand = c(0.05, 0)) +
  labs(
    title = "Renter Share",
    subtitle = "% of occupied units",
    x = NULL,
    y = "Renter %"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    plot.subtitle = element_text(color = "#666", size = 10),
    panel.grid.minor = element_blank()
  )
```

</div>
</div>

```{r affordability_analysis, fig.height=4.5}
county_panel %>%
  mutate(rent_to_income = (med_rent_real * 12) / med_income_real) %>%
  ggplot(aes(x = year, y = rent_to_income)) +
  geom_hline(yintercept = 0.30, linetype = "dashed", color = "#e74c3c", alpha = 0.6) +
  geom_line(size = 1.2, color = "#34495e") +
  geom_point(size = 2.5, color = "#34495e") +
  annotate("text", x = min(county_panel$year), y = 0.305,
           label = "30% Cost Burden Threshold", hjust = 0, size = 3.5, color = "#e74c3c") +
  scale_y_continuous(labels = percent, limits = c(0.15, 0.40), expand = c(0, 0)) +
  labs(
    title = "Housing Affordability: Annual Rent-to-Income Ratio",
    subtitle = "Ratio above 30% indicates cost burden per HUD guidelines",
    x = NULL,
    y = "Rent / Income"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(color = "#666", size = 12),
    panel.grid.minor = element_blank()
  )
```

<div class="insight">
**County-Level Observations:** Jefferson County shows `r if(abs(pop_change_county) < 0.02) "relatively stable population" else if(pop_change_county > 0) paste0("population growth of ", percent(pop_change_county, 0.1)) else paste0("population decline of ", percent(abs(pop_change_county), 0.1))` over the analysis period. Real median household income has `r if(income_change_county > 0) "increased" else "decreased"` by `r percent(abs(income_change_county), 0.1)`, while vacancy rates have `r if(vacancy_change_county > 0) "risen" else "fallen"` by `r sprintf("%.1f", abs(vacancy_change_county * 100))` percentage points.
</div>

---

## Portfolio Tract-Level Analysis

The portfolio's `r total_properties` properties are located across `r length(portfolio_tracts)` census tracts. This section analyzes demographic and housing trends specifically within these tracts.

### Tract Classification Distribution

```{r tract_classification_summary}
classification_summary <- tract_classifications %>%
  filter(GEOID %in% portfolio_tracts) %>%
  count(classification) %>%
  mutate(pct = n / sum(n))

classification_summary %>%
  mutate(
    classification = factor(classification, levels = c("Growth", "Stable", "Weakening")),
    n = as.integer(n),
    pct = percent(pct, 0.1)
  ) %>%
  arrange(classification) %>%
  kable(
    col.names = c("Classification", "Number of Tracts", "% of Portfolio Tracts"),
    align = c("l", "r", "r")
  )
```

### Tract Performance Metrics

```{r tract_metrics_table}
tract_classifications %>%
  filter(GEOID %in% portfolio_tracts) %>%
  left_join(tract_counts, by = c("GEOID" = "tract_geoid")) %>%
  arrange(desc(pop_cagr)) %>%
  transmute(
    `Census Tract` = GEOID,
    Classification = classification,
    `Properties` = coalesce(property_count, 0L),
    `Pop CAGR` = percent(pop_cagr, 0.1),
    `Income CAGR` = percent(income_cagr, 0.1),
    `Vacancy Δ` = sprintf("%+.1f pp", vacancy_change * 100),
    `Pop Change Sig.` = ifelse(pop_change_sig, "✓", "—"),
    `Income Change Sig.` = ifelse(income_change_sig, "✓", "—")
  ) %>%
  kable(align = c("l", "l", "r", "r", "r", "r", "c", "c"))
```

<div class="technical-note">
**Significance Testing:** Statistical significance determined using ACS margins of error. Changes marked with ✓ are distinguishable from zero at ~90% confidence level.
</div>

### Tract Trends Over Time

```{r tract_trends, fig.height=6}
tract_panel <- tract_history %>%
  filter(GEOID %in% portfolio_tracts) %>%
  left_join(tract_classifications %>% select(GEOID, classification), by = "GEOID")

# Population
p1 <- tract_panel %>%
  ggplot(aes(x = year, y = total_popE, group = GEOID, color = classification)) +
  geom_line(alpha = 0.6, size = 0.8) +
  scale_color_manual(
    values = c("Growth" = "#27ae60", "Stable" = "#f39c12", "Weakening" = "#e74c3c"),
    na.value = "#95a5a6"
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Population by Tract",
    x = NULL,
    y = "Population",
    color = "Classification"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    legend.position = "none",
    panel.grid.minor = element_blank()
  )

# Income
p2 <- tract_panel %>%
  ggplot(aes(x = year, y = med_income_real, group = GEOID, color = classification)) +
  geom_line(alpha = 0.6, size = 0.8) +
  scale_color_manual(
    values = c("Growth" = "#27ae60", "Stable" = "#f39c12", "Weakening" = "#e74c3c"),
    na.value = "#95a5a6"
  ) +
  scale_y_continuous(labels = dollar) +
  labs(
    title = "Median Household Income (Real 2023$)",
    x = NULL,
    y = "Income",
    color = "Classification"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    legend.position = "none",
    panel.grid.minor = element_blank()
  )

# Vacancy
p3 <- tract_panel %>%
  ggplot(aes(x = year, y = vacancy_rate, group = GEOID, color = classification)) +
  geom_line(alpha = 0.6, size = 0.8) +
  scale_color_manual(
    values = c("Growth" = "#27ae60", "Stable" = "#f39c12", "Weakening" = "#e74c3c"),
    na.value = "#95a5a6"
  ) +
  scale_y_continuous(labels = percent) +
  labs(
    title = "Vacancy Rate",
    x = NULL,
    y = "Vacancy Rate",
    color = "Classification"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )

gridExtra::grid.arrange(p1, p2, p3, ncol = 3)
```

### Demographic Composition (Portfolio Tracts)

```{r demographics, fig.height=5}
tract_latest_demo <- tract_history %>%
  filter(GEOID %in% portfolio_tracts, year == max(year))

# Education
p_edu <- tract_latest_demo %>%
  ggplot(aes(x = pct_bachelors)) +
  geom_histogram(bins = 15, fill = "#3498db", alpha = 0.7, color = "white") +
  scale_x_continuous(labels = percent) +
  labs(
    title = "Educational Attainment",
    subtitle = "% with Bachelor's degree or higher",
    x = "% Bachelor's+",
    y = "Number of Tracts"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    plot.subtitle = element_text(color = "#666", size = 10),
    panel.grid.minor = element_blank()
  )

# Race composition (latest year average across tracts)
race_comp <- tract_latest_demo %>%
  summarise(
    White = weighted.mean(pct_white, total_popE, na.rm = TRUE),
    Black = weighted.mean(pct_black, total_popE, na.rm = TRUE),
    Asian = weighted.mean(pct_asian, total_popE, na.rm = TRUE),
    Hispanic = weighted.mean(pct_hispanic, total_popE, na.rm = TRUE)
  ) %>%
  pivot_longer(everything(), names_to = "race", values_to = "pct") %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Asian")))

p_race <- race_comp %>%
  ggplot(aes(x = race, y = pct, fill = race)) +
  geom_col(alpha = 0.8, width = 0.7) +
  scale_fill_manual(values = c("White" = "#95a5a6", "Black" = "#34495e",
                                "Hispanic" = "#e67e22", "Asian" = "#9b59b6")) +
  scale_y_continuous(labels = percent, expand = c(0, 0), limits = c(0, max(race_comp$pct) * 1.1)) +
  labs(
    title = "Racial/Ethnic Composition",
    subtitle = "Population-weighted average across portfolio tracts",
    x = NULL,
    y = "% of Population"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    plot.subtitle = element_text(color = "#666", size = 10),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )

gridExtra::grid.arrange(p_edu, p_race, ncol = 2)
```

---

## Geographic Context: ZCTA-Level Analysis

ZIP Code Tabulation Areas (ZCTAs) provide broader geographic context beyond census tracts. The analysis includes all ZCTAs intersecting Jefferson County.

### ZCTA Classification Summary

```{r zcta_summary}
zcta_class_summary <- zcta_classifications_full %>%
  count(classification) %>%
  mutate(pct = n / sum(n))

zcta_class_summary %>%
  mutate(
    classification = factor(classification, levels = c("Growth", "Stable", "Weakening")),
    n = as.integer(n),
    pct = percent(pct, 0.1)
  ) %>%
  arrange(classification) %>%
  kable(
    col.names = c("Classification", "Number of ZCTAs", "% of ZCTAs"),
    align = c("l", "r", "r")
  )
```

### Interactive ZCTA Map

```{r zcta_map, out.width='100%', fig.height=7}
if (nrow(zcta_classifications_full) > 0) {
  # Get county boundary
  county_geom <- counties(state = "AL", cb = TRUE, year = 2022, class = "sf") %>%
    filter(COUNTYFP == "073") %>%
    st_transform(4326)

  # Get ZCTA geometries
  zcta_geom <- zctas(cb = TRUE, year = 2020, class = "sf") %>%
    st_transform(4326) %>%
    st_make_valid() %>%
    st_collection_extract("POLYGON")

  # Intersect with county
  zcta_county <- zcta_geom %>%
    st_intersection(county_geom) %>%
    select(GEOID = ZCTA5CE20, geometry)

  # Join classifications
  zcta_map_data <- zcta_county %>%
    left_join(zcta_classifications_full, by = "GEOID")

  # Color palette
  pal <- colorFactor(
    palette = c("Growth" = "#27ae60", "Stable" = "#f39c12", "Weakening" = "#e74c3c"),
    domain = c("Growth", "Stable", "Weakening"),
    na.color = "#bdc3c7"
  )

  # Create map
  leaflet(zcta_map_data, width = "100%", height = 600) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addPolygons(
      fillColor = ~pal(classification),
      color = "#ffffff",
      weight = 1.5,
      opacity = 1,
      fillOpacity = 0.7,
      label = ~paste0("ZCTA ", GEOID, ": ", coalesce(classification, "No Data")),
      popup = ~paste0(
        "<b>ZCTA ", GEOID, "</b><br>",
        "Classification: ", coalesce(classification, "No Data"), "<br>",
        "Pop CAGR: ", percent(pop_cagr, 0.1), "<br>",
        "Income CAGR: ", percent(income_cagr, 0.1), "<br>",
        "Vacancy Change: ", sprintf("%+.1f pp", vacancy_change * 100)
      ),
      highlightOptions = highlightOptions(
        weight = 3,
        color = "#333",
        fillOpacity = 0.9,
        bringToFront = TRUE
      )
    ) %>%
    addPolygons(
      data = county_geom,
      fill = FALSE,
      color = "#000000",
      weight = 3,
      opacity = 1
    ) %>%
    addLegend(
      "bottomright",
      pal = pal,
      values = ~classification,
      title = "ZCTA Classification",
      opacity = 1,
      na.label = "No Data"
    )
}
```

---

## Portfolio Geographic Distribution

### Property Location Map

```{r portfolio_map, out.width='100%', fig.height=7}
# Create color palette
pal_props <- colorFactor(
  palette = c("Growth" = "#27ae60", "Stable" = "#f39c12", "Weakening" = "#e74c3c"),
  domain = c("Growth", "Stable", "Weakening"),
  na.color = "#95a5a6"
)

# Create map
leaflet(prop_with_classification, width = "100%", height = 600) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    ~long, ~lat,
    radius = 7,
    color = "#ffffff",
    weight = 2,
    opacity = 1,
    fillColor = ~pal_props(classification),
    fillOpacity = 0.8,
    label = ~full_address,
    popup = ~paste0(
      "<b>", full_address, "</b><br>",
      "Tract: ", tract_geoid, "<br>",
      "Classification: <b>", coalesce(classification, "Unknown"), "</b><br>",
      "Pop Change: ", percent(pop_change, 0.1),
      ifelse(pop_change_sig, " ✓", ""), "<br>",
      "Real Income Change: ", percent(income_change_real, 0.1),
      ifelse(income_change_sig, " ✓", ""), "<br>",
      "Vacancy Change: ", sprintf("%+.1f pp", vacancy_change * 100),
      ifelse(vacancy_change_sig, " ✓", "")
    )
  ) %>%
  addLegend(
    "bottomright",
    pal = pal_props,
    values = ~classification,
    title = "Tract Classification",
    opacity = 1,
    na.label = "Unknown"
  )
```

### Property Distribution by Tract

```{r property_distribution}
tract_counts %>%
  arrange(desc(property_count)) %>%
  head(10) %>%
  left_join(tract_classifications, by = c("tract_geoid" = "GEOID")) %>%
  transmute(
    `Census Tract` = tract_geoid,
    `Properties` = property_count,
    Classification = classification,
    `Pop CAGR` = percent(pop_cagr, 0.1),
    `Income CAGR` = percent(income_cagr, 0.1)
  ) %>%
  kable(
    caption = "Top 10 Tracts by Property Count",
    align = c("l", "r", "l", "r", "r")
  )
```

---

## Strategic Implications

### Key Findings

Based on the data analysis:

1. **Geographic Concentration:** The portfolio is concentrated in `r length(portfolio_tracts)` census tracts, with `r percent(growth_properties/properties_with_tract, 0.1)` of properties located in tracts classified as "Growth" based on statistically significant improvements in population and/or income.

2. **Tract-Level Fundamentals:** Portfolio tracts show `r if(length(portfolio_tracts) > 0) "varying" else "limited"` performance across demographic indicators. The tract classification methodology identifies areas with measurable positive momentum versus those showing signs of stress.

3. **County Context:** Jefferson County as a whole has experienced `r if(abs(pop_change_county) < 0.02) "stable population levels" else if(pop_change_county > 0) "modest population growth" else "population decline"`, with real income trends `r if(income_change_county > 0) "upward" else "downward"` over the analysis period.

4. **Housing Market Dynamics:** County-level vacancy rates have `r if(vacancy_change_county > 0) "increased" else "decreased"`, while rent-to-income ratios `r if(latest_county$med_rent_real * 12 / latest_county$med_income_real > 0.30) "exceed" else "remain below"` the 30% affordability threshold.

### Data Limitations

- **ACS Sampling Error:** Census tract estimates carry margins of error; only statistically significant changes are flagged in classifications
- **Time Lag:** Most recent ACS 5-year estimates lag by 1-2 years from current market conditions
- **Aggregation:** Tract-level data may mask block-level variation within neighborhoods
- **No Property Performance:** This analysis focuses solely on macro demographic trends; property-level operating metrics not included

### Recommended Next Steps

1. **Monitor Weakening Tracts:** `r weakening_properties` properties sit in tracts showing demographic stress; consider deeper investigation
2. **Validate Recent Trends:** Supplement ACS data with real-time market indicators (listing activity, permit data, etc.)
3. **Property Performance Overlay:** Link tract classifications to actual rent growth, vacancy duration, and renewal rates
4. **Expansion Analysis:** Use tract classification methodology to screen potential acquisition targets

---

<div class="methodology">

## Technical Appendix

### Data Sources

- **American Community Survey (ACS):** U.S. Census Bureau 5-year estimates (`r analysis_period`)
- **Geographic Boundaries:** Census TIGER/Line shapefiles (2020-2022 vintages)
- **Inflation Adjustment:** Consumer Price Index for All Urban Consumers (CPI-U), annual averages

### Variable Definitions

```{r variable_table}
variable_dictionary %>%
  kable(
    col.names = c("Metric", "Description", "Source"),
    align = c("l", "l", "l")
  )
```

### Classification Methodology

**Growth Cluster:**
- Statistically significant population increase (change > MOE at ~90% confidence)
- AND real median household income CAGR ≥ 1% annually
- AND stable or declining vacancy rate

**Weakening Cluster:**
- Statistically significant population decline
- OR statistically significant income decline
- OR vacancy rate increase ≥ 1 percentage point with statistical significance

**Stable Cluster:**
- No statistically significant changes meeting Growth or Weakening criteria

**Statistical Significance:** Determined using ACS margins of error (MOE). For derived metrics (e.g., ratios, differences), MOEs propagated using Census Bureau formulas:
- Sum MOE: `sqrt(sum(SE^2)) * 1.645`
- Ratio MOE: `sqrt((SE_num/denom)^2 + (num*SE_denom/denom^2)^2) * 1.645`
- Difference MOE: `sqrt(SE1^2 + SE2^2) * 1.645`

### Analysis Limitations

- Tract boundaries may change over time (boundary consistency not validated)
- 5-year ACS estimates represent rolling averages and overlap across years
- Small population tracts have larger margins of error
- Property geocoding accuracy depends on Census Geocoder match quality

### Software & Reproducibility

Analysis conducted in R (≥4.2) using:
- `tidycensus` for ACS data retrieval
- `tidyverse` for data manipulation
- `sf` and `tigris` for spatial operations
- `leaflet` for interactive mapping

Full code and data pipeline available in project repository.

</div>

---

<div style="text-align: center; color: #999; font-size: 0.85rem; margin-top: 60px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
Report generated `r format(Sys.time(), '%B %d, %Y at %I:%M %p')` | Analysis period: `r analysis_period`
</div>
