---
title: "Market Intelligence Report"
subtitle: "Deep Dive: Jefferson County & Portfolio Analysis"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    code_folding: hide
    css: null
---

<style>
body {
  font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
  color: #333;
  background-color: #f8f9fa;
  line-height: 1.6;
}
.main-container {
  max-width: 1200px;
  margin: 0 auto;
  background-color: #ffffff;
  padding: 40px;
  box-shadow: 0 0 20px rgba(0,0,0,0.05);
  border-radius: 8px;
}
h1, h2, h3, h4 {
  color: #2c3e50;
  font-weight: 700;
  letter-spacing: -0.02em;
}
h1 {
  border-bottom: 2px solid #e9ecef;
  padding-bottom: 15px;
  margin-bottom: 40px;
  font-size: 2.5rem;
}
h2 {
  margin-top: 50px;
  margin-bottom: 25px;
  font-size: 1.8rem;
  border-left: 5px solid #3498db;
  padding-left: 15px;
}
h3 {
  margin-top: 30px;
  margin-bottom: 20px;
  font-size: 1.4rem;
  color: #34495e;
}
.nav-tabs {
  border-bottom: 2px solid #dee2e6;
  margin-bottom: 30px;
}
.nav-tabs > li > a {
  color: #495057;
  font-weight: 600;
  border: none;
  border-bottom: 2px solid transparent;
}
.nav-tabs > li.active > a, .nav-tabs > li.active > a:hover, .nav-tabs > li.active > a:focus {
  color: #3498db;
  border: none;
  border-bottom: 2px solid #3498db;
  background-color: transparent;
}
.card {
  background: #fff;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 25px;
  margin-bottom: 30px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.02);
  transition: transform 0.2s;
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.05);
}
.metric-box {
  text-align: center;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 6px;
  margin-bottom: 15px;
}
.metric-value {
  font-size: 2rem;
  font-weight: 700;
  color: #2c3e50;
}
.metric-label {
  font-size: 0.9rem;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.insight-box {
  background-color: #e8f4f8;
  border-left: 4px solid #3498db;
  padding: 15px 20px;
  margin: 20px 0;
  border-radius: 0 4px 4px 0;
  font-style: italic;
  color: #2c3e50;
}
details.accordion {
  margin: 15px 0 20px;
  border: 1px solid #e0e4e8;
  border-radius: 8px;
  background: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}
details.accordion summary {
  padding: 14px 16px;
  font-weight: 700;
  cursor: pointer;
  list-style: none;
}
details.accordion summary::-webkit-details-marker {
  display: none;
}
details.accordion .accordion-body {
  padding: 0 18px 16px;
  border-top: 1px solid #eef2f5;
  background: #fff;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center", dpi = 300)
library(tidyverse)
library(sf)
library(leaflet)
library(DT)
library(scales)
library(tigris)

# Load Data
final_data <- read_rds("../data/processed/final_analytical_data.rds")
properties <- final_data$property_reference
property_crosswalk <- final_data$property_crosswalk
tract_counts <- final_data$tract_counts
zcta_counts <- final_data$zcta_counts
county_counts <- final_data$county_counts
tract_history <- final_data$tract_history
zcta_history <- final_data$zcta_history
zcta_history_full <- final_data$zcta_history_full
classifications <- final_data$tract_classifications
zcta_classifications <- final_data$zcta_classifications
zcta_classifications_full <- final_data$zcta_classifications_full
variable_dictionary <- final_data$variable_dictionary
spec_years <- range(tract_history$year, na.rm = TRUE)

# Setup Tigris
options(tigris_use_cache = TRUE)

# --- Helper Functions ---
calc_cagr <- function(start_val, end_val, years) {
  (end_val / start_val)^(1 / years) - 1
}

# --- Data Preparation for Deep Dive ---

# 1. County Deep Dive Data
county_panel <- final_data$county_history_1yr
if (nrow(county_panel) == 0) county_panel <- final_data$county_history_5yr

county_expanded <- county_panel %>%
  mutate(
    # Affordability
    rent_to_income = (med_rent_real * 12) / med_income_real,
    # Tenure
    renter_share = renter_occupiedE / (renter_occupiedE + owner_occupiedE),
    owner_share = owner_occupiedE / (renter_occupiedE + owner_occupiedE),
    # Age Cohorts (Approximation based on available buckets)
    # Assuming standard ACS buckets are mapped.
    # Gen Z (approx < 25 in 2023), Millennials (25-44), Gen X (45-59), Boomers+ (60+)
    # Note: These buckets shift over time, but for a static view we use age groups.
    # Better: Use Age Groups directly.
    pop_under_18 = age_m_under5E + age_m_5_9E + age_m_10_14E + age_m_15_17E +
      age_f_under5E + age_f_5_9E + age_f_10_14E + age_f_15_17E,
    pop_18_34 = age_m_18_19E + age_m_20E + age_m_21E + age_m_22_24E + age_m_25_29E + age_m_30_34E +
      age_f_18_19E + age_f_20E + age_f_21E + age_f_22_24E + age_f_25_29E + age_f_30_34E,
    pop_35_54 = age_m_35_39E + age_m_40_44E + age_m_45_49E + age_m_50_54E +
      age_f_35_39E + age_f_40_44E + age_f_45_49E + age_f_50_54E,
    pop_55_plus = age_m_55_59E + age_m_60_61E + age_m_62_64E + age_m_65_66E + age_m_67_69E +
      age_m_70_74E + age_m_75_79E + age_m_80_84E + age_m_85_plusE +
      age_f_55_59E + age_f_60_61E + age_f_62_64E + age_f_65_66E + age_f_67_69E +
      age_f_70_74E + age_f_75_79E + age_f_80_84E + age_f_85_plusE
  ) %>%
  mutate(
    pct_under_18 = pop_under_18 / total_popE,
    pct_18_34 = pop_18_34 / total_popE,
    pct_35_54 = pop_35_54 / total_popE,
    pct_55_plus = pop_55_plus / total_popE
  )

latest_yr <- max(county_expanded$year)
start_yr <- min(county_expanded$year)

# Portfolio Summary Stats
prop_joined <- properties %>%
  left_join(classifications, by = c("tract_geoid" = "GEOID"))

growth_props <- prop_joined %>%
  filter(classification == "Growth") %>%
  nrow()
total_props <- nrow(prop_joined)
growth_pct <- growth_props / total_props
```

## Executive Summary

This **Deep Dive Market Intelligence Report** evaluates the demographic, housing, and economic landscape of **Jefferson County, AL**, and the specific performance of the **`r total_props` properties** within the portfolio.

### Strategic Overview

<div class="row">
<div class="col-md-4">
<div class="metric-box">
<div class="metric-value">`r percent(growth_pct)`</div>
<div class="metric-label">Portfolio in Growth Tracts</div>
</div>
</div>
<div class="col-md-4">
<div class="metric-box">
<div class="metric-value">`r percent(county_expanded$rent_to_income[county_expanded$year == latest_yr], 0.1)`</div>
<div class="metric-label">Rent-to-Income Ratio (2023)</div>
</div>
</div>
<div class="col-md-4">
<div class="metric-box">
<div class="metric-value">`r percent(county_expanded$vacancy_rate[county_expanded$year == latest_yr], 0.1)`</div>
<div class="metric-label">County Vacancy Rate</div>
</div>
</div>
</div>

<div class="insight-box">
**Key Takeaway:** The portfolio is well-positioned in high-growth areas. However, rising rent-to-income ratios in the broader county suggest a tightening affordability environment, which may support rental demand but also signals potential ceiling on rent growth without income gains.
</div>

---

> Sections below are collapsed by default—click a heading to reveal details and visuals.

## Deep Dive Analysis

<details class="accordion">
<summary>Population & Age Structure</summary>
<div class="accordion-body">

### Population Dynamics

**Demographic shifts drive housing demand.** We track total growth and who is driving it.

```{r pop_analysis, fig.width=10, fig.height=6}
# 1. Total Population Trend
p_pop_total <- county_expanded %>%
  ggplot(aes(x = year, y = total_popE)) +
  geom_area(fill = "#e1f5fe", alpha = 0.5) +
  geom_line(color = "#039be5", size = 1.2) +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  labs(title = "Total Population", subtitle = "Steady baseline trend", x = NULL, y = NULL)

# 2. Age Cohort Evolution (Stacked Area)
cohort_long <- county_expanded %>%
  select(year, pct_under_18, pct_18_34, pct_35_54, pct_55_plus) %>%
  pivot_longer(-year, names_to = "cohort", values_to = "pct") %>%
  mutate(cohort = factor(cohort,
    levels = c("pct_55_plus", "pct_35_54", "pct_18_34", "pct_under_18"),
    labels = c("55+ (Boomers/Seniors)", "35-54 (Gen X/Millennials)", "18-34 (Gen Z/Young Pro)", "<18 (Gen Alpha)")
  ))

p_cohorts <- ggplot(cohort_long, aes(x = year, y = pct, fill = cohort)) +
  geom_area(alpha = 0.85, color = "white") +
  scale_fill_manual(values = c(
    "55+ (Boomers/Seniors)" = "#2c3e50",
    "35-54 (Gen X/Millennials)" = "#3498db",
    "18-34 (Gen Z/Young Pro)" = "#2ecc71",
    "<18 (Gen Alpha)" = "#f1c40f"
  )) +
  scale_y_continuous(labels = percent) +
  theme_minimal() +
  labs(title = "Age Structure Evolution", subtitle = "Shift in generational weight", x = NULL, y = NULL, fill = NULL) +
  theme(legend.position = "bottom")
```

<div class="row">
<div class="col-md-5">
<div class="card">
```{r pop_total_display, fig.height=4}
p_pop_total
```
</div>
</div>
<div class="col-md-7">
<div class="card">
```{r cohorts_display, fig.height=4}
p_cohorts
```
</div>
</div>
</div>

<div class="insight-box">
**Signals to watch:** Rising **18–34** share supports rentals; growing **55+** points to accessibility and downsizing demand; stable **<18** keeps a future household pipeline in place.
</div>

</div>
</details>

<details class="accordion">
<summary>Housing Market Health</summary>
<div class="accordion-body">

### Housing Market Health

**Supply, Demand, and Affordability.**

```{r housing_analysis, fig.width=10, fig.height=5}
# 1. Affordability: Rent to Income
p_affordability <- county_expanded %>%
  ggplot(aes(x = year, y = rent_to_income)) +
  geom_hline(yintercept = 0.30, linetype = "dashed", color = "red", alpha = 0.5) +
  geom_line(color = "#e74c3c", size = 1.2) +
  geom_point(size = 2, color = "#c0392b") +
  annotate("text", x = min(county_expanded$year), y = 0.305, label = "Burden Threshold (30%)", color = "red", hjust = 0, size = 3) +
  scale_y_continuous(labels = percent, limits = c(0.15, 0.35)) +
  theme_minimal() +
  labs(title = "Housing Affordability", subtitle = "Rent-to-Income Ratio", x = NULL, y = NULL)

# 2. Tenure Trends
tenure_long <- county_expanded %>%
  select(year, renter_share, owner_share) %>%
  pivot_longer(-year, names_to = "tenure", values_to = "pct") %>%
  mutate(tenure = ifelse(tenure == "renter_share", "Renter", "Owner"))

p_tenure <- ggplot(tenure_long, aes(x = year, y = pct, color = tenure)) +
  geom_line(size = 1.2) +
  scale_color_manual(values = c("Owner" = "#2ecc71", "Renter" = "#f39c12")) +
  scale_y_continuous(labels = percent) +
  theme_minimal() +
  labs(title = "Market Tenure Split", subtitle = "Renter vs. Owner Occupancy", x = NULL, y = NULL, color = NULL) +
  theme(legend.position = "bottom")

# 3. Vacancy vs Rent Growth
# Calculate YoY Rent Growth
county_expanded <- county_expanded %>%
  arrange(year) %>%
  mutate(rent_growth = (med_rent_real - lag(med_rent_real)) / lag(med_rent_real))

p_vacancy_rent <- county_expanded %>%
  filter(!is.na(rent_growth)) %>%
  ggplot(aes(x = year)) +
  geom_col(aes(y = rent_growth, fill = "Real Rent Growth"), alpha = 0.6) +
  geom_line(aes(y = vacancy_rate / 4, color = "Vacancy Rate"), size = 1.2) + # Scaling vacancy to fit
  scale_y_continuous(
    labels = percent, name = "Rent Growth",
    sec.axis = sec_axis(~ . * 4, labels = percent, name = "Vacancy Rate")
  ) +
  scale_fill_manual(values = c("Real Rent Growth" = "#3498db")) +
  scale_color_manual(values = c("Vacancy Rate" = "#e74c3c")) +
  theme_minimal() +
  labs(title = "Supply/Demand Dynamics", subtitle = "Rent Growth vs Vacancy", x = NULL, color = NULL, fill = NULL) +
  theme(legend.position = "bottom")
```

<div class="row">
<div class="col-md-4">
<div class="card">
```{r afford_display, fig.height=4}
p_affordability
```
</div>
</div>
<div class="col-md-4">
<div class="card">
```{r tenure_display, fig.height=4}
p_tenure
```
</div>
</div>
<div class="col-md-4">
<div class="card">
```{r vac_rent_display, fig.height=4}
p_vacancy_rent
```
</div>
</div>
</div>

<div class="insight-box">
**Market Health Check:**
*   **Affordability:** A rising Rent-to-Income ratio indicates that rent growth is outpacing income growth, potentially squeezing tenant budgets.
*   **Tenure:** An uptick in renter share often correlates with high interest rates or home price appreciation locking out first-time buyers.
*   **Dynamics:** Typically, falling vacancy precedes rent spikes. Watch for divergence where vacancy rises *and* rents rise, which may indicate a supply mismatch (e.g., new luxury supply vs. affordable demand).
</div>

</div>
</details>

<details class="accordion">
<summary>Economic Resilience</summary>
<div class="accordion-body">

### Economic Resilience

**Income Power and Employment.**

```{r econ_analysis, fig.width=10, fig.height=4}
# Real Income vs Inflation (CPI implied by adjustment)
# Since we already adjusted to 2023$, flat line means keeping up with inflation.
# Rising line means beating inflation.

p_income_real <- county_expanded %>%
  ggplot(aes(x = year, y = med_income_real)) +
  geom_line(color = "#27ae60", size = 1.2) +
  geom_smooth(method = "lm", se = FALSE, color = "#27ae60", linetype = "dashed", alpha = 0.5) +
  scale_y_continuous(labels = dollar) +
  theme_minimal() +
  labs(title = "Real Purchasing Power", subtitle = "Median Household Income (2023$)", x = NULL, y = NULL)

# Unemployment & Poverty
p_distress <- county_expanded %>%
  select(year, unemployment_rate, poverty_rate) %>%
  pivot_longer(-year, names_to = "metric", values_to = "pct") %>%
  mutate(metric = ifelse(metric == "unemployment_rate", "Unemployment", "Poverty")) %>%
  ggplot(aes(x = year, y = pct, color = metric)) +
  geom_line(size = 1.2) +
  scale_color_manual(values = c("Poverty" = "#8e44ad", "Unemployment" = "#95a5a6")) +
  scale_y_continuous(labels = percent) +
  theme_minimal() +
  labs(title = "Economic Stress Indicators", subtitle = "Poverty & Unemployment Rates", x = NULL, y = NULL, color = NULL) +
  theme(legend.position = "bottom")
```

<div class="row">
<div class="col-md-6">
<div class="card">
```{r inc_real_display, fig.height=4}
p_income_real
```
</div>
</div>
<div class="col-md-6">
<div class="card">
```{r distress_display, fig.height=4}
p_distress
```
</div>
</div>
</div>

</div>
</details>

---

## Geographic Intelligence

<details class="accordion">
<summary>ZCTA Map (Jefferson County)</summary>
<div class="accordion-body">

### ZCTA Map

**Neighborhood-Level Growth Signals**

```{r zcta_map, out.width='100%', fig.height=7}
if (nrow(zcta_classifications_full) > 0) {
  county_geom <- counties(state = "AL", cb = TRUE, year = 2022, class = "sf") %>%
    filter(COUNTYFP == "073") %>%
    st_transform(4326)

  zcta_geom <- zctas(cb = TRUE, year = 2020, class = "sf") %>%
    st_transform(4326) %>%
    st_make_valid() %>%
    st_collection_extract("POLYGON") %>%
    st_intersection(county_geom) %>%
    select(geometry, GEOID = ZCTA5CE20)

  zcta_map_df <- zcta_geom %>%
    left_join(zcta_classifications_full, by = "GEOID")

  pal_zcta <- colorFactor(
    palette = c(Growth = "#2ca25f", Stable = "#fdae6b", Weakening = "#de2d26"),
    domain = c("Growth", "Stable", "Weakening"),
    na.color = "#f0f0f0"
  )

  leaflet(zcta_map_df) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addPolygons(
      fillColor = ~ pal_zcta(classification),
      color = "white",
      weight = 1,
      opacity = 1,
      fillOpacity = 0.7,
      label = ~ paste0("ZCTA ", GEOID, ": ", classification %||% "No Data"),
      highlightOptions = highlightOptions(weight = 2, color = "#666", fillOpacity = 0.9, bringToFront = TRUE)
    ) %>%
    addPolygons(
      data = county_geom,
      fill = FALSE,
      color = "#333",
      weight = 2,
      opacity = 1
  ) %>%
    addLegend("bottomright", pal = pal_zcta, values = zcta_map_df$classification, title = "Market Classification", opacity = 1)
}
```

</div>
</details>

<details class="accordion">
<summary>Portfolio Map</summary>
<div class="accordion-body">

### Portfolio Map

**Asset Locations & Performance**

```{r portfolio_map, out.width='100%', fig.height=7}
pal <- colorFactor(c("#2ca25f", "#fdae6b", "#de2d26"), domain = c("Growth", "Stable", "Weakening"))

leaflet(prop_joined) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    ~long, ~lat,
    color = ~ pal(classification),
    radius = 6,
    fillOpacity = 0.8,
    stroke = TRUE,
    weight = 1,
    opacity = 1,
    popup = ~ paste0(
      "<b>", full_address, "</b><br>",
      "Tract: ", tract_geoid, "<br>",
      "Class: <span style='color:", pal(classification), "; font-weight:bold'>", classification, "</span><br>",
      "Pop Change: ", percent(pop_change, 0.1), "<br>",
      "Real Income Change: ", percent(income_change_real, 0.1)
    )
  ) %>%
  addLegend("bottomright", pal = pal, values = ~classification, title = "Neighborhood Trend", opacity = 1)
```

</div>
</details>

<details class="accordion">
<summary>Tract-Level Table</summary>
<div class="accordion-body">

### Tract Data

**Granular Asset Metrics**

```{r tract_table}
tract_summary <- final_data$tract_classifications %>%
  filter(GEOID %in% unique(prop_joined$tract_geoid)) %>%
  left_join(tract_history %>% group_by(GEOID) %>% summarise(latest_year = max(year)), by = "GEOID") %>%
  arrange(classification, desc(pop_cagr))

tract_summary %>%
  transmute(
    Tract = GEOID,
    Classification = classification,
    `Pop CAGR` = percent(pop_cagr, 0.1),
    `Income CAGR` = percent(income_cagr, 0.1),
    `Vacancy Δ` = percent(vacancy_change, 0.1),
    `Pop Sig` = ifelse(pop_change_sig, "Yes", "-"),
    `Inc Sig` = ifelse(income_change_sig, "Yes", "-")
  ) %>%
  datatable(
    options = list(pageLength = 10, dom = "tp"),
    rownames = FALSE,
    class = "cell-border stripe"
  )
```

</div>
</details>

---

## Technical Appendix

<details class="accordion">
<summary>Methodology & Definitions</summary>
<div class="accordion-body">

### Methodology & Definitions

*   **Data Source**: US Census Bureau, ACS 5-year (tract/ZCTA) 2013–`r max(spec_years)`; ACS 1-year county through 2023.
*   **Inflation Adjustment**: All monetary values adjusted to 2023 dollars using CPI-U annual averages.
*   **Rent-to-Income Ratio**: Calculated as `(Median Gross Rent * 12) / Median Household Income`. A ratio > 30% indicates housing cost burden.
*   **Classification Logic**:
    *   **Growth**: Statistically significant population increase AND ≥1% real income CAGR with stable/declining vacancy.
    *   **Weakening**: Significant population/income decline OR significant vacancy increase (>1 pp).
    *   **Stable**: No statistically significant movement on core indicators.

</div>
</details>

<details class="accordion">
<summary>Variable Catalog</summary>
<div class="accordion-body">

### Variable Catalog

```{r var_table}
if (nrow(variable_dictionary) > 0) {
  variable_dictionary %>%
    datatable(options = list(pageLength = 10, dom = "tp"), rownames = FALSE)
}
```

</div>
</details>
